version: '3'
services:
  munimap-nginx:
    image: library/nginx:1.21.0-alpine
    ports:
      - 80:80
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
    extra_hosts:
      - host.docker.internal:host-gateway
    depends_on:
      - munimap-app

  munimap-postgis:
    image: mdillon/postgis:11-alpine
    ports:
      - 5555:5432
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    #command: ["postgres", "-c", "log_statement=all"]
    volumes:
      - ./postgres/postgresql_init_data:/docker-entrypoint-initdb.d
      - ./postgres/postgresql_data:/var/lib/postgresql/data:Z

  munimap-app:
    restart: unless-stopped
    build:
      context: ../
    ports:
      - 5000:8080
    # command: bash -c 'sleep infinity'
    command: python /opt/munimap/bin/manage.py -c /opt/etc/munimap/munimap.conf runserver -h 0.0.0.0 -p 8080
    depends_on:
      - munimap-postgis
      - munimap-print

  munimap-mapserver:
    restart: unless-stopped
    build:
      context: ./mapserver
    environment:
      # This only serves mapfiles within /opt/etc/styles/bielefeld/map/
      MS_MAP_PATTERN: '^\/opt\/etc\/styles\/bielefeld\/map\/.+\.map$$'
    ports:
      - 8080:80

  munimap-mapproxy:
    restart: unless-stopped
    build:
      context: ./mapproxy
    ports:
      - 8081:8181
    volumes:
      - ./mapproxy_cache_data:/opt/var/mapproxy/cache_data
    depends_on:
      - munimap-mapserver
  